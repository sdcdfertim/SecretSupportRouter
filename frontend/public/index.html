<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin"/>
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp"/>
  <title>Secret Support Router · Zama FHEVM</title>

  <style>
    :root{
      --bg:#0b1020; --ink:#e6eaf6; --muted:#a3b0c7; --line:#1e2742;
      --card:#0f1730; --elev:#111a38; --accent:#6de1ff; --accent2:#a78bfa; --good:#34d399; --bad:#fb7185;
      --mono: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      --sans: Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;
      --r:18px; --shadow: 0 20px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family:var(--sans); line-height:1.5;
      background:
        radial-gradient(900px 600px at 10% -10%, rgba(167,139,250,.15), transparent 60%),
        radial-gradient(900px 600px at 110% 10%, rgba(109,225,255,.15), transparent 60%),
        linear-gradient(180deg, #0a0f1e 0%, #0a1022 50%, #0b1226 100%);
    }
    .shell{max-width:1200px;margin:24px auto;padding:0 18px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(17,26,56,.8), rgba(14,22,46,.6));
      border:1px solid var(--line); border-radius: var(--r); padding:14px 16px; box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px;height:44px;border-radius:12px;display:grid;place-items:center;
      background:
        radial-gradient(60% 60% at 30% 30%, rgba(109,225,255,.4), transparent 60%),
        radial-gradient(60% 60% at 70% 70%, rgba(167,139,250,.4), transparent 60%),
        #0b1126;
      border:1px solid #233058; box-shadow: inset 0 0 0 1px rgba(173,216,230,.15), 0 10px 30px rgba(109,225,255,.15);
      color:#cde8ff; font-weight:900; letter-spacing:.5px;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand small{display:block;color:var(--muted);font-weight:600}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(15,23,56,.6)}
    .btn{
      appearance:none; border:1px solid var(--line); background:linear-gradient(180deg,#172347,#0f1839);
      color:#e8f2ff; padding:10px 14px; border-radius:12px; font-weight:800; letter-spacing:.2px; cursor:pointer;
      transition: .15s transform, .15s box-shadow; box-shadow: 0 10px 25px rgba(0,0,0,.3);
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(0,0,0,.35); }
    .btn[disabled]{opacity:.6; cursor:not-allowed; transform:none}
    .btn.primary{ background: linear-gradient(180deg,#2a3f87,#1f2d63); border-color:#2f3e7a; }
    .btn.accent{ background: linear-gradient(180deg,#30b5d9,#218fb3); border-color:#2bb1d6;}
    .btn.good{ background: linear-gradient(180deg,#10b981,#0a8f62); border-color:#10b981;}
    .btn.bad{ background: linear-gradient(180deg,#ef4444,#b91c1c); border-color:#ef4444;}

    .grid{display:grid; grid-template-columns: 320px 1fr; gap:18px; margin-top:18px}
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .panel{
      background: linear-gradient(180deg, rgba(17,27,60,.85), rgba(12,20,44,.85));
      border:1px solid var(--line); border-radius: var(--r); box-shadow: var(--shadow); padding:16px;
    }
    .panel h2{margin:0 0 6px; font-size:16px; letter-spacing:.15px}
    .muted{color:var(--muted)}
    .card{ background: linear-gradient(180deg, rgba(13,20,42,.9), rgba(9,15,34,.95)); border:1px solid var(--line); border-radius:16px; padding:14px; }
    .stack{display:grid; gap:10px}
    label{font-size:11px; text-transform: uppercase; letter-spacing:.12em; color:#c7d2fe; font-weight:800}
    input, select{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid #22315b;
      background: #0b1230; color:#eaf2ff; outline:none; font-weight:800; letter-spacing:.2px;
      transition:.15s;
    }
    input:focus{ border-color:#3a5bd9; box-shadow: 0 0 0 4px rgba(58,91,217,.18); }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .two{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .mono{font-family:var(--mono)}
    .kpi{display:grid; grid-template-columns: repeat(3,1fr); gap:10px}
    .kpi .card{display:grid; gap:4px}
    .value{font:900 18px var(--mono)}
    .ok{color:var(--good)} .err{color:var(--bad)} .accent{color:var(--accent)}

    .status{
      min-height:48px; border:1px dashed #2a3760; border-radius:12px; display:flex; align-items:center; justify-content:center;
      font:700 12px var(--mono); color:#cde8ff; background: rgba(10,17,40,.6); padding:8px;
    }

    .handle{
      background:#081028; border:1px dashed #21305a; color:#cde8ff; font:700 12px var(--mono);
      padding:10px; border-radius:12px; word-break:break-all;
    }
    .mesh{
      position:relative; overflow:hidden; border-radius: var(--r);
    }
    .mesh::after{
      content:""; position:absolute; inset:-40%; background:
        radial-gradient(600px 300px at 30% 10%, rgba(109,225,255,.08), transparent 60%),
        radial-gradient(600px 300px at 70% 80%, rgba(167,139,250,.08), transparent 60%);
      filter: blur(16px); pointer-events:none;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="mesh">
      <div class="brand">
        <div class="logo">FHE</div>
        <div>
          <h1>Secret Support Router</h1>
          <small class="muted">Homomorphic ticket → hidden agent match (Sepolia)</small>
        </div>
      </div>
      <div class="row">
        <span id="net" class="pill">Network: —</span>
        <span id="addr" class="pill mono">—</span>
        <button id="btnConnect" class="btn primary">Connect Wallet</button>
      </div>
    </header>

    <section class="grid">
      <!-- LEFT: Admin & Utilities -->
      <aside class="panel">
        <h2>Admin · Agents</h2>
        <p class="muted">Owner uploads encrypted skill vectors (4 dims). Values are kept private onchain; only routing result is decryptable by user & RouterApp.</p>

        <div class="card stack" style="margin-top:10px">
          <div class="two">
            <div>
              <label>Agent ID (uint32)</label>
              <input id="agentId" type="number" min="1" placeholder="e.g. 101"/>
            </div>
            <div>
              <label>Status</label>
              <select id="agentActive">
                <option value="1">active</option>
                <option value="0">inactive</option>
              </select>
            </div>
          </div>
          <div class="two">
            <div><label>Skill[0]</label><input id="s0" type="number" min="0" max="65535" placeholder="0..65535"/></div>
            <div><label>Skill[1]</label><input id="s1" type="number" min="0" max="65535" placeholder="0..65535"/></div>
          </div>
          <div class="two">
            <div><label>Skill[2]</label><input id="s2" type="number" min="0" max="65535" placeholder="0..65535"/></div>
            <div><label>Skill[3]</label><input id="s3" type="number" min="0" max="65535" placeholder="0..65535"/></div>
          </div>
          <div class="row">
            <button id="btnAgentEnc" class="btn accent">Upsert Encrypted</button>
            <!-- Plain (dev) removed by request -->
            <button id="btnAgentRemove" class="btn bad">Remove</button>
          </div>
          <div id="adminStatus" class="status">—</div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="kpi">
            <div class="card">
              <div class="muted">Active agents (list size)</div>
              <div id="kpiAgents" class="value">—</div>
            </div>
            <div class="card">
              <div class="muted">Owner</div>
              <div id="kpiOwner" class="value">—</div>
            </div>
            <div class="card">
              <div class="muted">RouterApp</div>
              <div id="kpiRouter" class="value">—</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT: User Tickets -->
      <main class="panel mesh">
        <h2>Submit Ticket (Encrypted)</h2>
        <p class="muted">Provide your needs vector and urgency. Contract computes an encrypted best agent id; you decrypt it privately via EIP-712.</p>

        <div class="card stack">
          <div class="two">
            <div><label>Need[0]</label><input id="n0" type="number" min="0" max="65535" placeholder="0..65535"/></div>
            <div><label>Need[1]</label><input id="n1" type="number" min="0" max="65535" placeholder="0..65535"/></div>
          </div>
          <div class="two">
            <div><label>Need[2]</label><input id="n2" type="number" min="0" max="65535" placeholder="0..65535"/></div>
            <div><label>Need[3]</label><input id="n3" type="number" min="0" max="65535" placeholder="0..65535"/></div>
          </div>
          <div class="two">
            <div><label>Urgency (uint16)</label><input id="urg" type="number" min="0" max="65535" placeholder="e.g. 30"/></div>
            <div><label>Ticket Salt</label><input id="salt" type="text" placeholder="leave blank to auto-generate"/></div>
          </div>
          <div class="row">
            <button id="btnSubmit" class="btn good">Submit & Decrypt</button>
            <button id="btnLookup" class="btn">Lookup by Ticket ID</button>
          </div>

          <div class="stack">
            <div class="muted">Ticket ID (keccak256 of salt • shown after send)</div>
            <div id="ticketIdBox" class="handle mono">—</div>
            <div class="muted">AgentId Encrypted Handle (from event)</div>
            <div id="handleBox" class="handle mono">—</div>
            <div id="userStatus" class="status">—</div>
            <div class="status">Best Agent: <span id="result" class="value accent" style="margin-left:8px">—</span></div>
          </div>
        </div>
      </main>
    </section>
  </div>

  <!-- SDKs (ESM) -->
  <script type="module" crossorigin src="https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js"></script>
  <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm"></script>

  <script type="module">
    import { BrowserProvider, Contract, keccak256, toUtf8Bytes, Interface } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm";
    import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";

    // ==== Config ====
    const CONTRACT_ADDRESS = "0xB9335126C6d39B7A694f4D896eac30Ae7d3073aE";
    const RELAYER_URL = "https://relayer.testnet.zama.org";
    const CHAIN_ID_HEX = "0xaa36a7"; // Sepolia

    // Minimal ABI
    const abi = [
      { type:"function", name:"version", inputs:[], outputs:[{type:"string"}], stateMutability:"pure" },
      { type:"function", name:"owner", inputs:[], outputs:[{type:"address"}], stateMutability:"view" },
      { type:"function", name:"routerApp", inputs:[], outputs:[{type:"address"}], stateMutability:"view" },
      { type:"function", name:"activeAgentCount", inputs:[], outputs:[{type:"uint256"}], stateMutability:"view" },

      { type:"function", name:"upsertAgentEncrypted",
        inputs:[ {type:"uint32", name:"agentId"}, {type:"bytes32[4]", name:"skillExt"}, {type:"bytes", name:"proof"}, {type:"bool", name:"active"} ],
        outputs:[], stateMutability:"nonpayable" },

      { type:"function", name:"removeAgent",
        inputs:[ {type:"uint32", name:"agentId"} ], outputs:[], stateMutability:"nonpayable" },

      { type:"function", name:"submitTicketAndRoute",
        inputs:[
          {type:"bytes32", name:"ticketId"},
          {type:"bytes32[4]", name:"needExt"},
          {type:"bytes32", name:"urgencyExt"},
          {type:"bytes", name:"proof"}
        ],
        outputs:[{type:"bytes32"}], stateMutability:"nonpayable" },

      { type:"function", name:"getMatchHandle",
        inputs:[{type:"bytes32", name:"ticketId"}],
        outputs:[{type:"bytes32"}], stateMutability:"view" },

      { type:"event",  name:"TicketSubmitted",
        inputs:[
          {indexed:true,  name:"ticketId",     type:"bytes32"},
          {indexed:true,  name:"user",         type:"address"},
          {indexed:false, name:"agentIdHandle",type:"bytes32"}
        ]},
    ];
    const iface = new Interface(abi);

    // ==== Shortcuts ====
    const $ = (id)=>document.getElementById(id);
    const els = {
      btnConnect: $("btnConnect"), net: $("net"), addr: $("addr"),
      // admin
      agentId: $("agentId"), agentActive: $("agentActive"),
      s0: $("s0"), s1: $("s1"), s2: $("s2"), s3: $("s3"),
      btnAgentEnc: $("btnAgentEnc"), btnAgentRemove: $("btnAgentRemove"),
      adminStatus: $("adminStatus"), kpiAgents: $("kpiAgents"), kpiOwner: $("kpiOwner"), kpiRouter: $("kpiRouter"),
      // user
      n0: $("n0"), n1: $("n1"), n2: $("n2"), n3: $("n3"), urg: $("urg"), salt: $("salt"),
      btnSubmit: $("btnSubmit"), btnLookup: $("btnLookup"),
      ticketIdBox: $("ticketIdBox"), handleBox: $("handleBox"), userStatus: $("userStatus"), result: $("result"),
    };

    els.addr.textContent = CONTRACT_ADDRESS;
    els.net.textContent = "Network: Sepolia";

    // ==== State ====
    let provider, signer, user, contract, relayer;

    // ==== Logger helpers (подробные логи) ====
    const now = () => performance.now();
    const KB = (n)=> (n/1024).toFixed(2)+' KB';
    const short = (a)=> a ? a.slice(0,6)+"…"+a.slice(-4) : "—";
    const TS = () => new Date().toISOString().replace('T',' ').replace('Z','');
    function group(title, fn){
      console.groupCollapsed(`%c${TS()} ${title}`, "color:#6de1ff");
      try{ return fn(); } finally { console.groupEnd(); }
    }
    async function agroup(title, fn){
      console.groupCollapsed(`%c${TS()} ${title}`, "color:#6de1ff");
      try{ return await fn(); } finally { console.groupEnd(); }
    }
    function status(el, text, type=null){
      el.textContent = text;
      el.className = "status"+(type===true?" ok": type===false?" err": "");
    }

    // ==== Connect ====
    els.btnConnect.onclick = async () => {
      await agroup("[CONNECT] Wallet + Relayer init", async () => {
        try{
          if(!window.ethereum) throw new Error("MetaMask not found");
          const t0 = now();
          provider = new BrowserProvider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          const net = await provider.getNetwork();
          console.log("chainId:", String(net.chainId));
          if(net.chainId !== 11155111n){
            console.log("Switching to Sepolia…");
            await provider.send("wallet_switchEthereumChain", [{ chainId: CHAIN_ID_HEX }]);
          }
          signer = await provider.getSigner();
          user = await signer.getAddress();
          contract = new Contract(CONTRACT_ADDRESS, abi, signer);
          console.log("Signer:", user);

          await initSDK();
          relayer = await createInstance({ ...SepoliaConfig, relayerUrl: RELAYER_URL, network: window.ethereum, debug:true });
          console.log("Relayer:", RELAYER_URL);

          els.btnConnect.textContent = short(user);
          status(els.adminStatus, "Connected: "+short(user), true);
          status(els.userStatus, "Relayer ready", true);

          // KPIs
          try{
            const [own, rout, cnt] = await Promise.all([contract.owner(), contract.routerApp(), contract.activeAgentCount()]);
            els.kpiOwner.textContent = short(own);
            els.kpiRouter.textContent = short(rout);
            els.kpiAgents.textContent = String(cnt);
            console.log("owner:", own, "routerApp:", rout, "activeAgents:", String(cnt));
          }catch(e){ console.warn("KPI fetch warn:", e); }

          console.log("Connect done in", (now()-t0).toFixed(1), "ms");
        }catch(e){
          console.error("Connect error:", e);
          status(els.adminStatus, e.message||String(e), false);
          status(els.userStatus, e.message||String(e), false);
        }
      });
    };

    // ==== Admin: upsert encrypted ====
    els.btnAgentEnc.onclick = async () => {
      await agroup("[ADMIN] Upsert Agent Encrypted", async () => {
        try{
          if(!contract || !relayer) throw new Error("Connect first");
          const agentId = Number(els.agentId.value||0);
          const active = els.agentActive.value === "1";
          const vals = [els.s0, els.s1, els.s2, els.s3].map(x=>Number(x.value||0));
          if(!(agentId>0)) throw new Error("Enter Agent ID");
          if(!vals.every(v => Number.isInteger(v) && v>=0 && v<=65535)) throw new Error("Skills must be uint16 (0..65535)");

          status(els.adminStatus, "Encrypting skills…");
          const t0 = now();
          console.groupCollapsed("%c[ENC] createEncryptedInput", "color:#a78bfa");
          const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, user);
          vals.forEach((v,i)=> { console.log(`add16(skill[${i}]):`, v); buf.add16(v); });
          const { handles, inputProof } = await buf.encrypt();
          console.log("handles:", handles);
          console.log("proof bytes:", inputProof?.length||0, `(${KB(inputProof?.length||0)})`);
          console.groupEnd();
          console.log("Encrypt+proof in", (now()-t0).toFixed(1), "ms");

          // (optional) simulate
          console.groupCollapsed("%c[SIM] staticCall upsertAgentEncrypted", "color:#a78bfa");
          try{
            await contract.upsertAgentEncrypted.staticCall(agentId, handles.slice(0,4), inputProof, active);
            console.log("staticCall OK");
          }catch(e){
            console.warn("staticCall revert (non-fatal):", e.shortMessage || e.message || e);
          }
          console.groupEnd();

          status(els.adminStatus, "Submitting tx…");
          const tx = await contract.upsertAgentEncrypted(agentId, handles.slice(0,4), inputProof, active);
          console.log("tx:", tx.hash);
          const rcpt = await tx.wait();
          console.log("mined: block", rcpt.blockNumber, "gasUsed", rcpt.gasUsed?.toString?.()||"");
          status(els.adminStatus, "Encrypted agent upserted ✓", true);

          try{ const cnt = await contract.activeAgentCount(); els.kpiAgents.textContent = String(cnt); }catch{}
        }catch(e){
          console.error("Upsert enc error:", e);
          status(els.adminStatus, e.message || String(e), false);
        }
      });
    };

    // ==== Admin: remove ====
    els.btnAgentRemove.onclick = async () => {
      await agroup("[ADMIN] Remove Agent", async () => {
        try{
          if(!contract) throw new Error("Connect first");
          const agentId = Number(els.agentId.value||0);
          if(!(agentId>0)) throw new Error("Enter Agent ID");
          status(els.adminStatus, "Submitting remove…");
          const tx = await contract.removeAgent(agentId);
          console.log("tx:", tx.hash);
          const rcpt = await tx.wait();
          console.log("mined: block", rcpt.blockNumber);
          status(els.adminStatus, "Agent removed ✓", true);
        }catch(e){
          console.error("Remove error:", e);
          status(els.adminStatus, e.message || String(e), false);
        }
      });
    };

    // ==== Helpers (tickets) ====
    const randSalt = () => {
      const r = crypto.getRandomValues(new Uint8Array(16));
      return Array.from(r).map(b=>b.toString(16).padStart(2,"0")).join("");
    };
    const ticketFromSalt = (s) => keccak256(toUtf8Bytes(s));

    async function bootstrapKP(){
      return await agroup("[USER] EIP-712 Signature (userDecrypt)", async () => {
        const kp = await generateKeypair();
        const startTs = Math.floor(Date.now()/1000).toString();
        const days = "7";
        const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, days);
        console.log("EIP712.domain:", eip.domain);
        console.log("EIP712.types:", eip.types);
        console.log("EIP712.message fields:", Object.keys(eip.message));
        const sig = await signer.signTypedData(
          eip.domain,
          { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
          eip.message
        );
        console.log("signature (hex len):", sig.length);
        return { kp, startTs, days, sig: sig.replace("0x","") };
      });
    }

    // ==== User: submit & decrypt ====
    els.btnSubmit.onclick = async () => {
      await agroup("[USER] Submit Ticket & Decrypt Result", async () => {
        try{
          if(!contract || !relayer) throw new Error("Connect first");
          const needs = [els.n0, els.n1, els.n2, els.n3].map(x=>Number(x.value||0));
          const urg = Number(els.urg.value||0);
          if(!needs.every(v => Number.isInteger(v) && v>=0 && v<=65535)) throw new Error("Need[0..3] must be uint16");
          if(!(Number.isInteger(urg) && urg>=0 && urg<=65535)) throw new Error("Urgency must be uint16");

          // Ticket
          let salt = (els.salt.value||"").trim();
          if(!salt){ salt = "salt-"+randSalt(); els.salt.value = salt; }
          const ticketId = ticketFromSalt(salt);
          els.ticketIdBox.textContent = ticketId;
          status(els.userStatus, "Encrypting payload…");

          // Encrypt (4 needs + urgency)
          const t0 = now();
          console.groupCollapsed("%c[ENC] createEncryptedInput", "color:#6de1ff");
          const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, user);
          needs.forEach((v,i)=> { console.log(`add16(need[${i}]):`, v); buf.add16(v); });
          console.log("add16(urgency):", urg); buf.add16(urg);
          const { handles, inputProof } = await buf.encrypt();
          console.log("handles:", handles);
          console.log("proof bytes:", inputProof?.length||0, `(${KB(inputProof?.length||0)})`);
          console.groupEnd();
          console.log("Encrypt+proof in", (now()-t0).toFixed(1), "ms");

          // staticCall
          console.groupCollapsed("%c[SIM] staticCall submitTicketAndRoute", "color:#6de1ff");
          try{
            await contract.submitTicketAndRoute.staticCall(ticketId, handles.slice(0,4), handles[4], inputProof);
            console.log("staticCall OK");
          }catch(e){
            console.warn("staticCall revert (non-fatal):", e.shortMessage || e.message || e);
          }
          console.groupEnd();

          // send tx
          status(els.userStatus, "Submitting tx…");
          const tx = await contract.submitTicketAndRoute(ticketId, handles.slice(0,4), handles[4], inputProof);
          console.groupCollapsed("%c[TX] sent", "color:#6de1ff");
          console.log("hash:", tx.hash);
          console.groupEnd();

          const rcpt = await tx.wait();
          console.groupCollapsed("%c[TX] mined", "color:#6de1ff");
          console.log("blockNumber:", rcpt.blockNumber, "gasUsed:", rcpt.gasUsed?.toString?.()||"");
          console.log("logs:", rcpt.logs.length);
          console.groupEnd();

          // parse event
          console.groupCollapsed("%c[EVT] TicketSubmitted parse", "color:#6de1ff");
          const topic = iface.getEvent("TicketSubmitted").topicHash;
          const log = rcpt.logs.find(l => l.topics?.[0] === topic);
          if(!log) throw new Error("TicketSubmitted not found");
          const parsed = iface.parseLog(log);
          console.log("ticketId:", parsed.args.ticketId);
          console.log("user:", parsed.args.user);
          console.log("agentIdHandle:", parsed.args.agentIdHandle);
          console.groupEnd();

          const handle = parsed.args.agentIdHandle;
          els.handleBox.textContent = handle;

          // userDecrypt
          status(els.userStatus, "Decrypting best agent…");
          const { kp, startTs, days, sig } = await bootstrapKP();

          console.groupCollapsed("%c[DEC] userDecrypt", "color:#6de1ff");
          const pairs = [{ handle, contractAddress: CONTRACT_ADDRESS }];
          console.log("pairs:", pairs);
          console.log("startTs:", startTs, "days:", days);
          const out = await relayer.userDecrypt(pairs, kp.privateKey, kp.publicKey, sig, [CONTRACT_ADDRESS], await signer.getAddress(), startTs, days);
          console.log("userDecrypt output keys:", Object.keys(out));
          console.groupEnd();

          let val = out[handle];
          if(val===undefined){
            const k = Object.keys(out).find(k=>k.toLowerCase() === String(handle).toLowerCase());
            val = k ? out[k] : undefined;
          }
          if(val===undefined) throw new Error("Decryption output missing");

          const best = typeof val === "string" ? BigInt(val) : BigInt(val);
          els.result.textContent = best.toString();
          status(els.userStatus, "Done", true);
        }catch(e){
          console.error("Submit error:", e);
          status(els.userStatus, e.message || String(e), false);
        }
      });
    };

    // ==== Lookup by ticketId ====
    els.btnLookup.onclick = async () => {
      await agroup("[USER] Lookup & Decrypt Stored Match", async () => {
        try{
          if(!contract || !relayer) throw new Error("Connect first");
          let salt = (els.salt.value||"").trim();
          if(!salt) throw new Error("Enter the same salt used previously");
          const ticketId = ticketFromSalt(salt);
          els.ticketIdBox.textContent = ticketId;

          console.groupCollapsed("%c[READ] getMatchHandle", "color:#6de1ff");
          const handle = await contract.getMatchHandle(ticketId);
          console.log("handle:", handle);
          console.groupEnd();

          if(handle === "0x0000000000000000000000000000000000000000000000000000000000000000"){
            throw new Error("No match stored for this ticket");
          }
          els.handleBox.textContent = handle;

          status(els.userStatus, "Decrypting stored match…");
          const { kp, startTs, days, sig } = await bootstrapKP();

          console.groupCollapsed("%c[DEC] userDecrypt (lookup)", "color:#6de1ff");
          const pairs = [{ handle, contractAddress: CONTRACT_ADDRESS }];
          console.log("pairs:", pairs);
          const out = await relayer.userDecrypt(pairs, kp.privateKey, kp.publicKey, sig, [CONTRACT_ADDRESS], await signer.getAddress(), startTs, days);
          console.log("userDecrypt output keys:", Object.keys(out));
          console.groupEnd();

          let val = out[handle];
          if(val===undefined){
            const k = Object.keys(out).find(k=>k.toLowerCase() === String(handle).toLowerCase());
            val = k ? out[k] : undefined;
          }
          if(val===undefined) throw new Error("Decryption output missing");

          const best = typeof val === "string" ? BigInt(val) : BigInt(val);
          els.result.textContent = best.toString();
          status(els.userStatus, "Done", true);
        }catch(e){
          console.error("Lookup error:", e);
          status(els.userStatus, e.message || String(e), false);
        }
      });
    };
  </script>
</body>
</html>
